class DraggableTextItem(QGraphicsTextItem):
    """A text item that can be dragged and maintains offset from parent sensor dot."""

    def __init__(self, text, parent, sensor_box, sensor_id, item_type):
        """
        Initialize draggable text item.

        Args:
            text: The text to display
            parent: The parent QGraphicsItem
            sensor_box: The SensorBoxItem this belongs to
            sensor_id: The sensor ID this text belongs to
            item_type: Type of item ('label', 'number', or 'value')
        """
        super().__init__(text, parent)
        self.sensor_box = sensor_box
        self.sensor_id = sensor_id
        self.item_type = item_type
        self.is_dragging = False
        self.drag_start_pos = None

        # Make the item movable
        self.setFlag(QGraphicsItem.GraphicsItemFlag.ItemIsMovable, True)
        self.setFlag(QGraphicsItem.GraphicsItemFlag.ItemIsSelectable, True)
        self.setCursor(Qt.CursorShape.OpenHandCursor)

    def mousePressEvent(self, event):
        """Handle mouse press - start dragging."""
        if event.button() == Qt.MouseButton.LeftButton:
            self.is_dragging = True
            self.drag_start_pos = self.pos()
            self.setCursor(Qt.CursorShape.ClosedHandCursor)
            event.accept()
        else:
            super().mousePressEvent(event)

    def mouseMoveEvent(self, event):
        """Handle mouse move - update position while dragging."""
        if self.is_dragging:
            # Let the default movement happen
            super().mouseMoveEvent(event)
            event.accept()
        else:
            super().mouseMoveEvent(event)

    def mouseReleaseEvent(self, event):
        """Handle mouse release - finish dragging and save offset."""
        if event.button() == Qt.MouseButton.LeftButton and self.is_dragging:
            self.is_dragging = False
            self.setCursor(Qt.CursorShape.OpenHandCursor)

            # Calculate offset from dot position
            if self.sensor_id in self.sensor_box.sensors:
                sensor_info = self.sensor_box.sensors[self.sensor_id]
                dot = sensor_info.get('dot')
                if dot:
                    # Get current position relative to parent (the sensor box)
                    current_pos = self.pos()
                    dot_pos = dot.pos()

                    # Calculate offset from dot
                    dx = current_pos.x() - dot_pos.x()
                    dy = current_pos.y() - dot_pos.y()

                    # Save the offset
                    self.sensor_box.save_label_offset(self.sensor_id, self.item_type, dx, dy)

            event.accept()
        else:
            super().mouseReleaseEvent(event)

